<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belgium Trip - Perfect Layout & Fan Hover</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <style>
        /* --- Âü∫Á§éË®≠ÂÆö (ÊØîÂà©ÊôÇÈõúË™åÈ¢®ÈÖçËâ≤) --- */
        body, html {
            margin: 0; padding: 0;
            overflow-x: hidden; overflow-y: auto; 
            background-color: #F9F6F0; 
            font-family: 'Noto Sans TC', sans-serif;
            color: #2C2A29; 
            height: auto; min-height: 100vh;
        }

        #back-btn {
            position: fixed; top: 20px; left: 20px; z-index: 100;
            background-color: #A62626; color: #F9F6F0; 
            padding: 10px 20px; border-radius: 30px;
            text-decoration: none; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center;
        }
        #back-btn:hover { background-color: #2C2A29; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); }

        #map-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 1; display: flex; justify-content: center; align-items: center;
            overflow: hidden; pointer-events: none; background-color: #F9F6F0; 
        }
        #responsive-stage { position: relative; width: 1000px; height: 1000px; flex-shrink: 0; transform-origin: center center; }
        #map-content-wrapper { position: absolute; width: 100%; height: 100%; top: 0; left: 0; transform-origin: 0 0; }
        #europe-map { width: 100%; height: 100%; display: block; object-fit: contain; }
        
        .marker { position: absolute; transform: translate(-50%, -50%); z-index: 6; opacity: 0; }
        .marker.waypoint-dot { width: 3px; height: 3px; background-color: #A62626; border: 0.5px solid #F9F6F0; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .marker.home-icon {
            width: 6px; height: 6px; background-color: #C19A2B; 
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'/%3E%3C/svg%3E") no-repeat center / contain;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z'/%3E%3C/svg%3E") no-repeat center / contain;
            filter: drop-shadow(0 3px 3px rgba(0,0,0,0.4));
        }

        .city-label {
            position: absolute; transform: translate(-50%, -50%); transform-origin: center center; 
            background: rgba(249, 246, 240, 0.95); padding: 1.5px 1px; 
            border-radius: 1px; box-shadow: 0 0.5px 2px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; text-align: center; 
            pointer-events: auto; z-index: 7; opacity: 0; visibility: hidden; white-space: nowrap; border: 0.5px solid none;
        }
        .city-label h3 { margin: 0; font-size: 3px; color: #A62626; font-family: 'Playfair Display', serif; font-weight: bold; }
        .city-label p { margin: 0.5px 0 1px 0; font-size: 2px; color: #2C2A29; font-weight: bold; }

        .city-label.stay-label { background: rgba(44, 42, 41, 0.95); border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.5); padding: 2px 4px; border-radius: 2px; }
        .city-label.stay-label .stay-city-name { font-size: 1.5px; color: #F9F6F0; margin: 0 0 0.2px 0; font-family: 'Playfair Display', serif; font-weight: normal; }
        .city-label.stay-label .stay-title { font-size: 3px; color: #C19A2B; letter-spacing: 0.2px; margin: 0 0 0.5px 0; font-weight: bold; text-transform: uppercase; }
        .city-label.stay-label p { color: #ccc; font-weight: normal; font-size: 1.5px; margin: 0; }

        .explore-btn {
            display: inline-block; text-decoration: none; background-color: #C19A2B; color: white;
            font-size: 1.8px; padding: 0.5px 2px; border-radius: 0.5px; margin-top: 1px; align-self: center; 
            transition: background-color 0.2s; cursor: pointer;
        }
        .explore-btn:hover { background-color: #A62626; }

        #map-dim-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(249, 246, 240, 0.85); opacity: 0; z-index: 5; pointer-events: none; }
        #cover-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('Photos/Belgium/Ghent/Belgium_Trip/cover.jpg') center/cover no-repeat; background-color: #333; z-index: 10; pointer-events: none; }
        #hero-text-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; background: rgba(0, 0, 0, 0.5); z-index: 20; pointer-events: none; }
        #hero-text-layer h1 { font-size: 4rem; margin: 0; font-weight: bold; font-family: 'Playfair Display', serif; }
        #hero-text-layer p { font-size: 1.5rem; opacity: 0.9; margin-top: 10px; }

        #end-title-layer { position: fixed; bottom: 40px; left: 40px; z-index: 40; pointer-events: none; color: #A62626; text-shadow: 0 2px 10px rgba(249, 246, 240, 0.9); opacity: 0; transform: translateY(100%); }
        #end-title-layer h1 { font-size: 3rem; margin: 0; font-weight: bold; font-family: 'Playfair Display', serif; }
        #end-title-layer p { font-size: 1.2rem; margin: 5px 0 0 0; color: #2C2A29; opacity: 0.9; font-weight: bold; }

        #story-content-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 30; pointer-events: none; }
        .story-element { position: absolute; left: 50%; width: 80%; max-width: 600px; opacity: 0; visibility: hidden; pointer-events: auto; }

        /* --- ÈªëÂ∫ïÂç°ÁâáÊîæÂ§ßËàáÊåâÈàïÈù†Âè≥‰∏ãËßí --- */
        .card-type-title {
            top: 50%; transform: translate(-150%, -50%) translateY(120vh); 
            background: #2C2A29; color: #F9F6F0; 
            padding: 30px 40px; 
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1); text-align: left;
            width: 80%; 
            max-width: 450px; 
            left: 5%; z-index: 50; display: flex; flex-direction: column; align-items: flex-start;
        }
        .card-type-title h2 { font-size: 3rem; margin: 0 0 10px 0; color: #C19A2B; font-family: 'Playfair Display', serif; }
        .card-type-title p { font-size: 1rem; margin: 0; opacity: 0.9; }

        .title-explore-btn {
            display: inline-block; 
            padding: 10px 24px; 
            background-color: #A62626; color: white; text-decoration: none; font-weight: bold;
            font-size: 1rem; 
            border-radius: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transition: transform 0.2s, background-color 0.2s; 
            margin-left: auto; 
        }
        .title-explore-btn:hover { transform: translateY(-2px); background-color: #C19A2B; }

        /* =========================================================
           „Äê‰ΩàÂ±ÄÈò≤Ê∫¢Âá∫‰øÆÊ≠£„Äë
           ========================================================= */
        .article-container {
            top: 50%; left: 50%; transform: translate(-50%, 0) translateY(120vh);
            width: 95%; max-width: 1400px; display: flex; flex-direction: column; z-index: 60;
            background: white; background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            background-blend-mode: multiply; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .article-container.stay-mode { background: transparent !important; box-shadow: none !important; border: none !important; }
        .article-container.transparent-bg { background: transparent !important; box-shadow: none !important; border: none !important; }

        .article-section {
            height: 80vh; min-height: 80vh; max-height: 80vh; 
            box-sizing: border-box; padding: 20px 5%; 
            display: flex; gap: 4%; align-items: center; justify-content: center; border-bottom: 1px dashed #e0e0e0;
            overflow: hidden; 
        }
        .article-section:last-child { border-bottom: none; }

        .img-wrapper { 
            position: relative; 
            width: 60%; 
            max-width: 750px; 
            height: 100%; 
            max-height: 550px; 
            flex-shrink: 1; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        .img-frame {
            position: absolute; 
            top: 50%; left: 50%; transform: translate(-50%, -50%); 
            max-width: 95%; max-height: 95%; 
            background-color: white; border: 8px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            overflow: hidden; opacity: 0; 
            transition: box-shadow 0.3s ease;
            display: block; 
        }

        .img-wrapper.interactive-ready:hover .img-frame {
            box-shadow: 0 15px 35px rgba(0,0,0,0.25);
        }

        .collage-img {
            display: block; 
            width: auto; height: auto; 
            max-width: 35vw; max-height: 60vh; 
            object-fit: contain; transform: scale(1.15); 
        }

        .text-content-wrapper { flex: 1; display: flex; flex-direction: column; justify-content: center; text-align: left; }
        .article-section.reverse { flex-direction: row-reverse; }
        .reverse .text-content-wrapper { text-align: right; }

        .section-subtitle { margin: 0 0 15px 0; font-size: 2.2rem; color: #C19A2B; font-family: 'Playfair Display', serif; font-weight: 700; opacity: 0; }
        .text-wrapper { display: flex; flex-direction: column; gap: 20px; border-left: 4px solid #2C2A29; padding-left: 30px; }
        .reverse .text-wrapper { border-left: none; border-right: 4px solid #2C2A29; padding-left: 0; padding-right: 30px; }
        .text-content-wrapper.full-width { align-items: center; text-align: center; }
        .text-content-wrapper.full-width .text-wrapper { border: none; padding: 0; }
        
        .text-item { font-size: 1.2rem; line-height: 1.8; opacity: 0; transition: all 0.3s ease; }
        .text-item span { display: inline-block; transform-origin: left center; }
        .highlight { font-size: 1.35em; font-weight: 900; color: #A62626; font-family: 'Playfair Display', serif; }

        #scroll-flow-container { position: relative; top: 0; left: 0; width: 100%; z-index: -1; }
        .ghost-step { width: 100%; height: 200vh; }

        /* --- Êñ∞Â¢ûÂäüËÉΩÂ∞àÂ±¨ CSS ÂçÄÂ°ä --- */
        #cover-city-list {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 40px; pointer-events: auto; z-index: 25;
        }
        .cover-city-chip {
            position: relative; padding: 12px 25px; background: rgba(249, 246, 240, 0.9); color: #2C2A29; 
            font-weight: bold; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; 
            overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.15); font-family: 'Playfair Display', serif; font-size: 1.2rem;
            border: 2px solid transparent; 
        }
        .cover-city-chip::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-img) center/cover; opacity: 0; z-index: -2; transition: opacity 0.4s ease;
        }
        .cover-city-chip::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); opacity: 0; z-index: -1; transition: opacity 0.4s ease;
        }
        .cover-city-chip:hover { 
            color: #F9F6F0; transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); border: 2px solid #C19A2B; 
        }
        .cover-city-chip:hover::before, .cover-city-chip:hover::after { opacity: 1; }

        /* È¶ñÈ†ÅÊªæÂãïÊèêÁ§∫ */
        #scroll-hint {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: white; font-size: 1.2rem; opacity: 0.8; z-index: 25; font-weight: bold;
            pointer-events: none; transition: opacity 0.5s ease;
            font-family: 'Playfair Display', serif; letter-spacing: 2px;
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translate(-50%, 0); }
            40% { transform: translate(-50%, -10px); }
            60% { transform: translate(-50%, -5px); }
        }

        /* ÂüéÂ∏Ç‰æøÊ¢ùÂ∑¶‰∏ãËßíÁöÑÊôØÈªû‰∏ãÊãâÈÅ∏ÂñÆ */
        .card-bottom-actions { 
            display: flex; width: 100%; justify-content: space-between; align-items: flex-end; 
            margin-top: auto; padding-top: 20px; 
        }
        .attraction-dropdown { position: relative; z-index: 100; pointer-events: auto; }
        
        .dropdown-btn { 
            background-color: transparent; border: 2px solid #C19A2B; color: #C19A2B; 
            padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; 
            transition: all 0.3s ease; font-family: 'Noto Sans TC', sans-serif; font-size: 0.9rem; outline: none; 
        }
        .dropdown-btn:hover { background-color: #C19A2B; color: #2C2A29; }
        /* üí° ÈõªËÖ¶ÁâàÈ°ØÁ§∫Âêë‰∏ãÁÆ≠È†≠ */
        .dropdown-btn span::after { content: ' ‚Üì'; }
        
        .dropdown-content { 
            display: none; position: absolute; top: calc(100% + 10px); left: 0; 
            background: rgba(249, 246, 240, 0.98); min-width: 220px; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.3); border-radius: 8px; 
            padding: 10px 0; max-height: 40vh; overflow-y: auto; pointer-events: auto; text-align: left; 
        }
        .dropdown-content.show { display: block; animation: fadeIn 0.2s ease; }
        .dropdown-content .attraction-item { 
            padding: 12px 18px; color: #2C2A29; cursor: pointer; font-size: 0.9rem; font-weight: bold; 
            border-left: 4px solid transparent; transition: all 0.2s ease; font-family: 'Noto Sans TC', sans-serif; 
        }
        .dropdown-content .attraction-item:hover { background: #e0e0e0; border-left: 4px solid #A62626; color: #A62626; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #back-to-top {
            position: fixed; bottom: 30px; right: 30px; z-index: 100;
            background-color: #C19A2B; color: white; width: 50px; height: 50px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease; opacity: 0; pointer-events: none; transform: translateY(20px);
        }
        #back-to-top.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
        #back-to-top:hover { background-color: #A62626; box-shadow: 0 6px 16px rgba(0,0,0,0.3); transform: translateY(-3px); }

        /* =========================================================
           üì± „ÄêÊâãÊ©üÈüøÊáâÂºèË®≠Ë®à RWDÔºöÊ•µËá¥‰øÆÂæ©„Äë
           ========================================================= */
        @media (max-width: 768px) {
            /* üí° 1. ÂüéÂ∏Ç‰æøÊ¢ù‰∏ãÁßªËá≥ 75%ÔºåÂÆåÁæéËÆìÂá∫‰∏äÊñπ 1/3 Áµ¶Âú∞Âúñ */
            .card-type-title {
                top: 75% !important;
                left: 5% !important;
                width: 90% !important;
                max-width: none !important;
                align-items: center !important;
                text-align: center !important;
                padding: 20px !important;
                box-sizing: border-box;
            }
            .card-bottom-actions {
                flex-direction: column; align-items: center; gap: 15px; justify-content: center;
            }
            .title-explore-btn { margin-left: 0; }
            
            /* üí° ÊâãÊ©üÁâàÊåâÈàïÈ°ØÁ§∫Âêë‰∏äÁÆ≠È†≠Ôºå‰∏¶Âêë‰∏äÂ±ïÈñã */
            .dropdown-btn span::after { content: ' ‚Üë'; }
            .dropdown-content { 
                top: auto !important; 
                bottom: calc(100% + 10px) !important; 
                left: 50% !important; 
                transform: translateX(-50%) !important; 
                text-align: center; 
            }
            
            .article-section, .article-section.reverse {
                flex-direction: column !important;
                min-height: 80vh !important;
                height: 80vh !important; 
                justify-content: center !important;
                padding: 0 5% !important;
            }
            .img-wrapper {
                width: 100% !important;
                height: 40vh !important;
                max-height: 40vh !important;
                margin-bottom: 10px !important;
                position: relative !important;
                z-index: 10 !important; 
            }
            .collage-img {
                max-width: 85vw !important;
                max-height: 35vh !important; 
            }
            .text-content-wrapper {
                align-items: center !important;
                text-align: center !important;
                margin-top: 0 !important;
                width: 100% !important;
                flex: 0 0 auto !important;
                position: relative !important;
                z-index: 1000 !important; 
            }
            .text-wrapper, .reverse .text-wrapper {
                display: none !important;
            }
            
            /* üí° 2. ‰øÆÊ≠£ÊñáÂ≠óÊéíÂàóÔºöÂº∑Âà∂ÂçÄÂ°äÁΩÆ‰∏≠‰∏îÂûÇÁõ¥ÊéíÂàóÔºåÈÅøÂÖçÂ∑¶Âè≥‰∏¶Êéí */
            .section-subtitle {
                display: block !important;
                text-align: center !important;
                min-height: 4em; 
                margin: 0 !important;
                font-size: 1.1rem !important;
                padding: 0 10px !important;
                line-height: 1.4 !important;
            }
            /* Â∞áÂÖßÈÉ®Ë¢´Âä†ÂÖ•ÁöÑ <span> Âº∑Âà∂ÊèõË°å */
            .section-subtitle span {
                display: block !important;
                margin-top: 5px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>

    <a href="Home.html" id="back-btn">Home</a>
    <div id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">‚Üë</div>

    <div id="map-container">
        <div id="responsive-stage">
            <div id="map-content-wrapper">
                <img id="europe-map" src="Europe_map_new.svg" alt="Map">
                <svg id="route-layer" viewBox="0 0 1000 1000" preserveAspectRatio="none" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 2;">
                    <defs id="route-defs"></defs>
                </svg>
                <div id="map-dim-layer"></div>
                <div id="markers-layer"></div>
            </div>
        </div>
    </div>

    <div id="cover-layer"></div>
    <div id="hero-text-layer">
        <h1 id="page-title">Loading...</h1>
        <p id="page-date">...</p>
        <div id="scroll-hint">Scroll to Explore ‚Üì</div>
    </div>
    <div id="end-title-layer">
        <h1 id="end-page-title">Loading...</h1>
        <p id="end-page-date">...</p>
    </div>
    <div id="story-content-layer"></div>
    <div id="scroll-flow-container"></div>

    <script src="data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <script>
        gsap.registerPlugin(ScrollTrigger);
        const TRANSFORM_PARAMS = { scaleX: 1.5, scaleY: 1.5, offsetX: -8, offsetY: 93 };
        
        // üí° ÊâãÊ©üÁâàÊôÇÔºåÂú∞ÂúñÁÑ¶ÈªûÂÆåÁæéÁΩÆÊñº‰∏äÊñπ 1/3
        function transformCoords(homeX, homeY) { return { x: (homeX * TRANSFORM_PARAMS.scaleX) + TRANSFORM_PARAMS.offsetX, y: (homeY * TRANSFORM_PARAMS.scaleY) + TRANSFORM_PARAMS.offsetY }; }
        function getFixedPosition(targetX, targetY, zoomLevel) { 
            let isMobile = window.innerWidth <= 768;
            let centerY = isMobile ? 333 : 500; 
            return { x: 500 - (targetX * zoomLevel), y: centerY - (targetY * zoomLevel) }; 
        }

        let CITY_DATE_RANGES = {}; 
        const frameBaseTransforms = new Map();

        // üí° 3. ÂÖ®ÂüüÈªûÊìäÂÅµÊ∏¨ÔºöÈªûÊìä‰ªª‰ΩïÂ§ñÈÉ®Á©∫ÁôΩËôïÔºåÊî∂ÂêàÊâÄÊúâÁãÄÊÖã‰∏¶ÈÇÑÂéüÊ®ôÈ°å
        window.addEventListener('click', (e) => {
            document.querySelectorAll('.dropdown-content.show').forEach(el => el.classList.remove('show'));

            if (window.innerWidth <= 768) {
                let clickedWrapper = e.target.closest('.img-wrapper');
                
                document.querySelectorAll('.img-wrapper.interactive-ready').forEach(wrapper => {
                    // Â¶ÇÊûúÈªûÊìäÁöÑÂú∞Êñπ‰∏çÂú®ÈÄôÂÄãÁõ∏ÁâáÂçÄÂ°äÂÖßÔºå‰∏îÈÄôÂÄãÂçÄÂ°äÊ≠£Âú®Â±ïÈñã‰∏≠ -> Â∞áÂÖ∂ÈÇÑÂéü
                    if (wrapper.isHovered && wrapper !== clickedWrapper) {
                        wrapper.isHovered = false;
                        wrapper.activeFrame = -1;
                        
                        let parts = wrapper.id.split('-'); 
                        let idx = parts[1];
                        let nIdx = parts[2];
                        
                        let subTitleEl = document.getElementById(`subtitle-${idx}-${nIdx}`);
                        if (subTitleEl && subTitleEl.hasAttribute('data-orig')) {
                            subTitleEl.innerHTML = subTitleEl.getAttribute('data-orig');
                            subTitleEl.style.color = "";
                        }
                        
                        let frames = wrapper.querySelectorAll('.img-frame');
                        frames.forEach((frameEl, fIdx) => {
                            let base = frameBaseTransforms.get(frameEl.id);
                            if (base) {
                                gsap.to(frameEl, { x: base.x, y: base.y, rotation: base.rotation, scale: 1, zIndex: fIdx + 1, opacity: 1, duration: 0.5, ease: "back.out(1.5)", overwrite: "auto" });
                            }
                        });
                    }
                });
            }
        });

        window.scrollToLabel = function(labelName) {
            const tl = window.mainTimeline;
            if (!tl || tl.labels[labelName] === undefined) return;
            const progress = tl.labels[labelName] / tl.duration();
            const scrollPos = tl.scrollTrigger.start + (tl.scrollTrigger.end - tl.scrollTrigger.start) * progress;
            window.scrollTo({ top: scrollPos, behavior: 'smooth' });
        };

        window.addEventListener('scroll', () => {
            const btt = document.getElementById('back-to-top');
            if (window.scrollY > window.innerHeight * 0.8) btt.classList.add('visible');
            else btt.classList.remove('visible');

            const hint = document.getElementById('scroll-hint');
            if (hint) {
                if (window.scrollY > 50) hint.style.opacity = '0';
                else hint.style.opacity = '0.8';
            }
        });

        function getMergedData() {
            const tripEvent = window.DATA.events.find(e => e.text === 'Belgium Trip');
            if (!tripEvent) return [];

            document.getElementById('page-title').textContent = tripEvent.text;
            const singleLineDate = tripEvent.date.replace(/<br\s*\/?>/ig, ' ~ ');
            document.getElementById('page-date').innerHTML = singleLineDate;
            document.getElementById('end-page-title').textContent = tripEvent.text;
            document.getElementById('end-page-date').innerHTML = singleLineDate;

            const mappedData = tripEvent.eventMarkers.map((evMarker, idx) => {
                let baseMarker = window.DATA.markers.home.find(m => m.id === evMarker.id);
                if (!baseMarker && tripEvent.countryCandidates) {
                    for (const country of tripEvent.countryCandidates) {
                        if (window.DATA.markers[country]) {
                            baseMarker = window.DATA.markers[country].find(m => m.id === evMarker.id);
                            if (baseMarker) break;
                        }
                    }
                }
                let finalCoords = { x: 0, y: 0 };
                if (baseMarker) finalCoords = transformCoords(baseMarker.x, baseMarker.y);

                let parsedNotes = [];
                if (evMarker.notes) {
                    evMarker.notes.forEach(note => {
                        let subNotes = [];
                        if (note.text1) {
                            let i = 1;
                            while (note[`text${i}`] || note[`photo${i}`] || note[`video${i}`]) {
                                let currentPhoto = note[`photo${i}`] || note[`video${i}`];
                                if (!currentPhoto && i === 1) currentPhoto = note.photo || note.video || "";
                                else if (!currentPhoto) currentPhoto = "";
                                subNotes.push({ photo: currentPhoto, text: note[`text${i}`] || "" });
                                i++;
                            }
                        } else if (note.photo || note.text || note.video) {
                            subNotes.push({ photo: note.photo || note.video || "", text: note.text || "" });
                        }
                        if(subNotes.length > 0) parsedNotes.push({ title: note.title || null, subNotes });
                    });
                } else if (evMarker.desc && !evMarker.stay) {
                    parsedNotes.push({ title: null, subNotes: [{ photo: "", text: evMarker.desc }] });
                }

                let itemType = evMarker.type;
                if (!itemType && !evMarker.stay) {
                    if (idx === 0) itemType = 'start'; else if (idx === tripEvent.eventMarkers.length - 1) itemType = 'end'; else itemType = 'waypoint';
                }

                return { ...evMarker, type: itemType, coords: finalCoords, parsedNotes: parsedNotes, labelOffset: evMarker.labelOffset || { x: 0, y: 0 } };
            }).filter(m => m.coords.x !== 0); 

            mappedData.forEach(item => {
                if (!item.stay && item.type === 'waypoint') {
                    if (!CITY_DATE_RANGES[item.city]) CITY_DATE_RANGES[item.city] = [];
                    CITY_DATE_RANGES[item.city].push(item.date);
                }
            });

            const finalData = [];
            for (let i = 0; i < mappedData.length; i++) {
                const current = mappedData[i];
                if (current.stay) {
                    let j = i + 1; let lastDate = current.date;
                    while (j < mappedData.length && mappedData[j].city === current.city && mappedData[j].stay) { lastDate = mappedData[j].date; j++; }
                    if (j > i + 1) { current.date = `${current.date} ~ ${lastDate}`; i = j - 1; }
                    finalData.push(current);
                } else {
                    finalData.push(current);
                }
            }
            return finalData;
        }

        const STORY_DATA = getMergedData();
        const SEEN_CITIES = new Set(); 

        function updateStage() {
            const scale = Math.max(window.innerWidth / 1000, window.innerHeight / 1000);
            document.getElementById("responsive-stage").style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', updateStage);

        function initStory() {
            updateStage();
            const markersLayer = document.getElementById('markers-layer');
            const contentLayer = document.getElementById('story-content-layer');
            const scrollContainer = document.getElementById('scroll-flow-container');
            const routeLayer = document.getElementById('route-layer');
            const routeDefs = document.getElementById('route-defs');
            
            scrollContainer.appendChild(Object.assign(document.createElement('div'), {className: 'ghost-step', style: 'height: 150vh'}));

            const heroLayer = document.getElementById('hero-text-layer');
            const coverCityList = document.createElement('div');
            coverCityList.id = 'cover-city-list';
            let coverSeen = new Set();

            STORY_DATA.forEach((item, index) => {
                if (index > 0) {
                    const prevItem = STORY_DATA[index - 1]; const pathData = `M ${prevItem.coords.x} ${prevItem.coords.y} L ${item.coords.x} ${item.coords.y}`;
                    const maskId = `path-mask-${index}`; const mask = document.createElementNS("http://www.w3.org/2000/svg", "mask");
                    mask.setAttribute("id", maskId); mask.setAttribute("maskUnits", "userSpaceOnUse");
                    const maskPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    maskPath.setAttribute("id", `mask-path-${index}`); maskPath.setAttribute("d", pathData);
                    maskPath.setAttribute("fill", "none"); maskPath.setAttribute("stroke", "white"); maskPath.setAttribute("stroke-width", "5"); 
                    mask.appendChild(maskPath); routeDefs.appendChild(mask);
                    const visiblePath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    visiblePath.setAttribute("d", pathData); visiblePath.setAttribute("fill", "none"); visiblePath.setAttribute("stroke", "#A62626"); 
                    visiblePath.setAttribute("stroke-width", "1.5"); visiblePath.setAttribute("stroke-dasharray", "6, 6"); 
                    visiblePath.setAttribute("mask", `url(#${maskId})`); routeLayer.appendChild(visiblePath);
                }

                if ((item.type === 'waypoint' || item.stay) && !coverSeen.has(item.city)) {
                    let bgImg = '';
                    let cityItems = STORY_DATA.filter(d => d.city === item.city);
                    for (let cItem of cityItems) {
                        if (cItem.parsedNotes) {
                            for (let n of cItem.parsedNotes) {
                                for (let s of n.subNotes) {
                                    if (s.photo && !s.photo.match(/\.(mov|mp4)$/i)) { bgImg = s.photo; break; }
                                }
                                if (bgImg) break;
                            }
                        }
                        if (bgImg) break;
                    }
                    
                    if (bgImg) {
                        coverSeen.add(item.city); 
                        let btn = document.createElement('div');
                        btn.className = 'cover-city-chip';
                        btn.innerText = item.city;
                        btn.style.setProperty('--bg-img', `url('${bgImg}')`);
                        
                        let targetIndex = index;
                        for (let i = index; i < STORY_DATA.length; i++) {
                            if (STORY_DATA[i].city === item.city && !STORY_DATA[i].stay && STORY_DATA[i].parsedNotes && STORY_DATA[i].parsedNotes.length > 0) {
                                targetIndex = i;
                                break;
                            }
                        }
                        btn.onclick = () => window.scrollToLabel(`cardCenter-${targetIndex}`);
                        coverCityList.appendChild(btn);
                    }
                }

                const marker = document.createElement('div');
                marker.className = (item.type === 'start' || item.type === 'end') ? 'marker home-icon' : 'marker waypoint-dot';
                marker.style.left = `${item.coords.x / 10}%`; marker.style.top = `${item.coords.y / 10}%`; marker.id = `marker-${index}`;
                markersLayer.appendChild(marker);

                const label = document.createElement('div'); label.id = `label-${index}`;
                let isDummyLabel = false; 
                
                let exploreLink = item.link;
                if (item.type === 'end' && item.city.includes("Munich")) {
                    exploreLink = "Germany.html"; 
                }
                const exploreBtn = exploreLink ? `<a href="${exploreLink}?city=${encodeURIComponent(item.city)}" class="explore-btn">Explore City &rarr;</a>` : '';
                const titleExploreBtn = exploreLink ? `<a href="${exploreLink}?city=${encodeURIComponent(item.city)}" class="title-explore-btn">Explore City &rarr;</a>` : '';

                if (item.stay) {
                    label.className = 'city-label stay-label'; label.innerHTML = `<h3 class="stay-city-name">${item.city}</h3><div class="stay-title">OVERNIGHT</div><p>${item.date}</p>`;
                } else if (item.type === 'waypoint') {
                    let firstVisitIndex = STORY_DATA.findIndex(d => d.type === 'waypoint' && d.city === item.city);
                    
                    if (firstVisitIndex === index) {
                        SEEN_CITIES.add(item.city); label.className = 'city-label';
                        const dateStr = item.date; 
                        label.innerHTML = `<h3>${item.city}</h3><p style="margin: 0.5px 0 1px 0;">${dateStr}<span id="revisit-comma-${item.city}" style="opacity: 0; width: 0; overflow: hidden; display: inline-block; vertical-align: middle;"></span><span id="revisit-date-${item.city}" style="opacity: 0; height: 0; overflow: hidden; display: block; margin-top: 0.5px;"></span></p>${exploreBtn}`;
                    } else if (firstVisitIndex !== -1 && firstVisitIndex < index) {
                        isDummyLabel = true; 
                        let revisitComma = document.getElementById(`revisit-comma-${item.city}`);
                        let revisitSpan = document.getElementById(`revisit-date-${item.city}`);
                        if (revisitComma && revisitSpan) {
                            revisitComma.textContent = `,`;
                            revisitSpan.textContent = item.date;
                        }
                    } else {
                        isDummyLabel = true;
                    }
                } else if (item.type === 'start') {
                    label.className = 'city-label'; const endItem = STORY_DATA.find(d => d.type === 'end' && d.city === item.city);
                    const endDateHTML = endItem ? `<span id="end-date-${index}" style="opacity: 0; height: 0; overflow: hidden; display: block;">End: ${endItem.date}</span>` : '';
                    label.innerHTML = `<h3>${item.city}</h3><p style="margin: 0.5px 0 1px 0;">Start: ${item.date}${endDateHTML}</p>${exploreBtn}`;
                } else if (item.type === 'end') {
                    if (STORY_DATA.find(d => d.type === 'start' && d.city === item.city)) isDummyLabel = true; 
                    else { label.className = 'city-label'; label.innerHTML = `<h3>${item.city}</h3><p>End: ${item.date}</p>${exploreBtn}`; }
                }

                if (isDummyLabel) label.style.display = 'none'; 
                else { label.style.left = `${(item.coords.x / 10) + (item.labelOffset?.x || 0)}%`; label.style.top = `${(item.coords.y / 10) + (item.labelOffset?.y || 0)}%`; }
                markersLayer.appendChild(label);

                const titleCard = document.createElement('div'); titleCard.className = 'story-element card-type-title'; titleCard.id = `city-${index}-title`;
                const titleSpacer = document.createElement('div'); titleSpacer.className = 'ghost-step';
                const articleContainer = document.createElement('div'); articleContainer.className = 'story-element article-container'; articleContainer.id = `city-${index}-article`;
                let totalSubNotes = 0; 
                
                let hasArticle = item.parsedNotes && item.parsedNotes.length > 0;

                if (!item.stay && !hasArticle) {
                    articleContainer.style.display = 'none';
                }

                if (item.stay) {
                    titleCard.style.display = 'none'; titleSpacer.style.height = '10vh'; articleContainer.classList.add('stay-mode');
                } else {
                    titleCard.innerHTML = `<h2>${item.city}</h2><p>${item.date}</p>`;
                    let bottomActions = document.createElement('div');
                    bottomActions.className = 'card-bottom-actions';

                    if (hasArticle) {
                        let attractions = [];
                        item.parsedNotes.forEach((note, noteIndex) => {
                            if (note.title) attractions.push({ title: note.title, idx: noteIndex });
                        });

                        if (attractions.length > 0) {
                            let dropdownContainer = document.createElement('div');
                            dropdownContainer.className = 'attraction-dropdown';
                            
                            let btn = document.createElement('button');
                            btn.className = 'dropdown-btn';
                            btn.innerHTML = '<span>Attraction List</span>';
                            
                            let content = document.createElement('div');
                            content.className = 'dropdown-content';
                            
                            attractions.forEach(attr => {
                                let itemEl = document.createElement('div');
                                itemEl.className = 'attraction-item';
                                itemEl.innerHTML = attr.title.replace(/<br\s*\/?>/ig, ' '); 
                                itemEl.onclick = (e) => {
                                    e.stopPropagation();
                                    window.scrollToLabel(`section-${index}-${attr.idx}`);
                                    content.classList.remove('show');
                                };
                                content.appendChild(itemEl);
                            });
                            
                            btn.onclick = (e) => {
                                e.stopPropagation();
                                document.querySelectorAll('.dropdown-content.show').forEach(el => {
                                    if (el !== content) el.classList.remove('show');
                                });
                                content.classList.toggle('show');
                            };
                            
                            dropdownContainer.appendChild(btn);
                            dropdownContainer.appendChild(content);
                            bottomActions.appendChild(dropdownContainer);
                        }
                    }

                    if (titleExploreBtn) {
                        let dummyDiv = document.createElement('div');
                        dummyDiv.innerHTML = titleExploreBtn;
                        if (dummyDiv.firstChild) {
                            bottomActions.appendChild(dummyDiv.firstChild);
                        }
                    }
                    titleCard.appendChild(bottomActions);

                    if (hasArticle) {
                        item.parsedNotes.forEach((note, noteIndex) => {
                            totalSubNotes += note.subNotes.length; 
                            const section = document.createElement('div'); section.className = `article-section ${noteIndex % 2 !== 0 ? 'reverse' : ''}`;
                            let hasPhoto = note.subNotes.some(sn => sn.photo);
                            
                            let imgHTML = '';
                            if (hasPhoto) {
                                imgHTML += `<div class="img-wrapper" id="wrapper-${index}-${noteIndex}">`;
                                note.subNotes.forEach((sn, i) => {
                                    if(sn.photo) {
                                        const isVideo = /\.(mp4|webm|mov)$/i.test(sn.photo);
                                        imgHTML += `<div id="frame-${index}-${noteIndex}-${i}" class="img-frame" style="z-index: ${i+1};">`;
                                        if (isVideo) {
                                            imgHTML += `<video id="img-${index}-${noteIndex}-${i}" class="collage-img" src="${sn.photo}" muted loop playsinline style="background:#000;"></video>`;
                                        } else {
                                            imgHTML += `<img id="img-${index}-${noteIndex}-${i}" class="collage-img" src="${sn.photo}">`;
                                        }
                                        imgHTML += `</div>`;
                                    }
                                });
                                imgHTML += `</div>`;
                            }

                            let textHTML = `<div class="text-content-wrapper ${!hasPhoto ? 'full-width' : ''}">`;
                            let origTitle = note.title ? note.title : '';
                            textHTML += `<h3 class="section-subtitle" id="subtitle-${index}-${noteIndex}" data-orig="${origTitle.replace(/"/g, '&quot;')}">${origTitle}</h3>`;
                            
                            // üí° 4. ‰øÆÂæ©ÔºöÁÑ°Ë´ñÊúâÁÑ°ÊñáÂ≠óÔºåÈÉΩÂº∑Âà∂ÁîüÊàêÂ∞çÊáâÁöÑ text-itemÔºå‰ª•‰æøÁ®çÂæåÁî± JS ÊõøÊèõÈÄ≤ÂâØÊ®ôÈ°å
                            textHTML += `<div class="text-wrapper">`;
                            note.subNotes.forEach((sn, i) => { 
                                let textContent = sn.text ? sn.text : '';
                                textHTML += `<div class="text-item" id="txt-${index}-${noteIndex}-${i}">${textContent}</div>`; 
                            });
                            textHTML += `</div></div>`;

                            section.innerHTML = imgHTML + textHTML; articleContainer.appendChild(section);
                        });
                    }
                }
                
                contentLayer.appendChild(titleCard); scrollContainer.appendChild(titleSpacer); contentLayer.appendChild(articleContainer);

                const articleSpacer = document.createElement('div'); articleSpacer.className = 'ghost-step';
                let spacerHeight = item.stay ? 60 : 100 + (item.parsedNotes?.length * 80 || 0) + (totalSubNotes * 60); 
                articleSpacer.style.height = `${spacerHeight}vh`; scrollContainer.appendChild(articleSpacer);
                scrollContainer.appendChild(Object.assign(document.createElement('div'), {className: 'ghost-step', style: 'height: 10vh'}));
            });

            heroLayer.appendChild(coverCityList); 

            scrollContainer.appendChild(Object.assign(document.createElement('div'), {className: 'ghost-step', style: 'height: 100vh'}));
            setTimeout(createTimeline, 100);
        }

        function applyDynamicFanEffect(wrapper, index, noteIndex, totalImages) {
            let visibleFrames = [];
            for (let i = 0; i < totalImages; i++) {
                let frameId = `frame-${index}-${noteIndex}-${i}`;
                let frameEl = document.getElementById(frameId);
                if (frameEl && gsap.getProperty(frameEl, "opacity") > 0.1) {
                    visibleFrames.push({ el: frameEl, id: frameId });
                }
            }

            let visibleCount = visibleFrames.length;
            if (visibleCount === 0) return;

            visibleFrames.forEach((item, visibleIdx) => {
                let base = frameBaseTransforms.get(item.id);
                if (!base) return;

                if (visibleCount === 1) {
                    gsap.to(item.el, { y: base.y - 30, scale: 1.05, duration: 0.4, ease: "power2.out", overwrite: "auto" });
                } else if (visibleCount === 2) {
                    let direction = visibleIdx === 0 ? -1 : 1; 
                    gsap.to(item.el, { x: base.x + (direction * 40), y: base.y - 15, rotation: base.rotation + (direction * 8), scale: 1.05, duration: 0.4, ease: "power2.out", overwrite: "auto" });
                } else {
                    let centerIndex = (visibleCount - 1) / 2;
                    let spreadFactor = visibleIdx - centerIndex; 
                    gsap.to(item.el, { x: base.x + (spreadFactor * 50), y: base.y - 10 - (Math.abs(spreadFactor) === 0 ? 20 : 0), rotation: base.rotation + (spreadFactor * 10), scale: 1.05, duration: 0.4, ease: "power2.out", overwrite: "auto" });
                }
            });
        }

        function initDynamicHover(wrapperId, index, noteIndex, totalImages) {
            const wrapper = document.getElementById(wrapperId);
            if (!wrapper) return;
            wrapper.activeFrame = -1;

            wrapper.addEventListener("mouseenter", () => {
                if (window.innerWidth <= 768) return;
                if (!wrapper.classList.contains("interactive-ready")) return;
                wrapper.isHovered = true; 
                applyDynamicFanEffect(wrapper, index, noteIndex, totalImages);
            });

            wrapper.addEventListener("mouseleave", () => {
                if (window.innerWidth <= 768) return;
                if (!wrapper.classList.contains("interactive-ready")) return;
                wrapper.isHovered = false; 
                for (let i = 0; i < totalImages; i++) {
                    let frameId = `frame-${index}-${noteIndex}-${i}`;
                    let frameEl = document.getElementById(frameId);
                    let base = frameBaseTransforms.get(frameId);
                    if (frameEl && base) {
                        gsap.to(frameEl, { x: base.x, y: base.y, rotation: base.rotation, scale: 1, duration: 0.5, ease: "back.out(1.5)", overwrite: "auto" });
                    }
                }
            });

            for (let i = 0; i < totalImages; i++) {
                let frameEl = document.getElementById(`frame-${index}-${noteIndex}-${i}`);
                let txtEl = document.getElementById(`txt-${index}-${noteIndex}-${i}`);
                
                if (frameEl) {
                    frameEl.addEventListener('mouseenter', () => {
                        if (window.innerWidth <= 768) return;
                        if (!wrapper.classList.contains("interactive-ready")) return;
                        
                        gsap.to(frameEl, { scale: 1.15, zIndex: 50, duration: 0.2, overwrite: "auto" });
                        if (txtEl) gsap.to(txtEl, { color: "#A62626", x: 10, duration: 0.2, overwrite: "auto" });
                        
                        for (let j = 0; j < totalImages; j++) {
                            if (j !== i) {
                                gsap.to(`#frame-${index}-${noteIndex}-${j}`, { opacity: 0.2, duration: 0.2, overwrite: "auto" });
                                let otherTxt = document.getElementById(`txt-${index}-${noteIndex}-${j}`);
                                if (otherTxt) gsap.to(otherTxt, { opacity: 0.2, duration: 0.2, overwrite: "auto" });
                            }
                        }
                    });

                    frameEl.addEventListener('mouseleave', () => {
                        if (window.innerWidth <= 768) return;
                        if (!wrapper.classList.contains("interactive-ready")) return;
                        
                        let returnScale = wrapper.isHovered ? 1.05 : 1; 
                        gsap.to(frameEl, { scale: returnScale, zIndex: i + 1, duration: 0.2, overwrite: "auto" });
                        if (txtEl) gsap.to(txtEl, { color: "#2C2A29", x: 0, duration: 0.2, overwrite: "auto" });
                        
                        for (let j = 0; j < totalImages; j++) {
                            if (j !== i) {
                                gsap.to(`#frame-${index}-${noteIndex}-${j}`, { opacity: 1, duration: 0.2, overwrite: "auto" });
                                let otherTxt = document.getElementById(`txt-${index}-${noteIndex}-${j}`);
                                if (otherTxt) gsap.to(otherTxt, { opacity: 1, duration: 0.2, overwrite: "auto" });
                            }
                        }
                    });

                    // üí° ÊâãÊ©üÂ∞àÁî®ÈªûÊìäÈÇèËºØ (‰øÆÊ≠£ÔºöÂñÆÂúñÁõ¥Êé•Â±ïÈñãÊñáÂ≠ó)
                    frameEl.addEventListener('click', (e) => {
                        if (window.innerWidth > 768) return;
                        e.stopPropagation(); 
                        if (!wrapper.classList.contains("interactive-ready")) return;
                        
                        let subTitleEl = document.getElementById(`subtitle-${index}-${noteIndex}`);

                        // Ëã•ÁÇ∫Â§öÂúñÔºåÁ¨¨‰∏ÄÊ¨°ÈªûÊìäÂÅöÊâáÂΩ¢Â±ïÈñãÔºõÂñÆÂúñÂâáÁõ¥Êé•Ë¶ñÁÇ∫ hovered ‰∏¶È°ØÁ§∫ÊñáÂ≠ó
                        if (totalImages > 1 && !wrapper.isHovered) {
                            wrapper.isHovered = true;
                            applyDynamicFanEffect(wrapper, index, noteIndex, totalImages);
                            return;
                        }

                        wrapper.isHovered = true; 

                        if (wrapper.activeFrame === i) {
                            wrapper.activeFrame = -1;
                            if (subTitleEl && subTitleEl.hasAttribute('data-orig')) {
                                subTitleEl.innerHTML = subTitleEl.getAttribute('data-orig');
                                subTitleEl.style.color = "";
                            }
                            for (let j = 0; j < totalImages; j++) {
                                let fEl = document.getElementById(`frame-${index}-${noteIndex}-${j}`);
                                let returnScale = (totalImages > 1) ? 1.05 : 1;
                                if (fEl) gsap.to(fEl, { scale: returnScale, zIndex: j + 1, opacity: 1, duration: 0.2, overwrite: "auto" });
                            }
                        } else {
                            wrapper.activeFrame = i;
                            let activeScale = (totalImages > 1) ? 1.15 : 1.05;
                            gsap.to(frameEl, { scale: activeScale, zIndex: 100, opacity: 1, duration: 0.2, overwrite: "auto" });
                            
                            if (subTitleEl && txtEl) {
                                subTitleEl.innerHTML = txtEl.innerHTML;
                                subTitleEl.style.color = "#A62626";
                            }
                            for (let j = 0; j < totalImages; j++) {
                                if (j !== i) {
                                    let fEl = document.getElementById(`frame-${index}-${noteIndex}-${j}`);
                                    let returnScale = (totalImages > 1) ? 1.05 : 1;
                                    if (fEl) gsap.to(fEl, { opacity: 0.2, scale: returnScale, zIndex: j + 1, duration: 0.2, overwrite: "auto" });
                                }
                            }
                        }
                    });
                }
            }
        }

        function createTimeline() {
            const tl = gsap.timeline({ scrollTrigger: { trigger: "body", start: "top top", end: "bottom bottom", scrub: 1, invalidateOnRefresh: true } });
            window.mainTimeline = tl; 

            gsap.set(".article-container", { xPercent: -50, yPercent: 0 }); 
            gsap.set("#map-content-wrapper", { x: 0, y: 0, scale: 1 });
            tl.to("#cover-layer", { opacity: 0, duration: 1.5 }).to("#hero-text-layer", { y: -200, opacity: 0, duration: 1.5 }, "<");

            STORY_DATA.forEach((item, index) => {
                const targetScale = 5; const pos = getFixedPosition(item.coords.x, item.coords.y, targetScale);
                tl.to("#map-content-wrapper", { scale: targetScale, x: pos.x, y: pos.y, duration: 2, ease: "power1.inOut" });

                if (index > 0) {
                    const maskPath = document.querySelector(`#mask-path-${index}`);
                    if (maskPath) { const len = maskPath.getTotalLength(); gsap.set(maskPath, { strokeDasharray: len, strokeDashoffset: len }); tl.to(maskPath, { strokeDashoffset: 0, duration: 2, ease: "power1.inOut" }, "<"); }
                }

                tl.to(`#marker-${index}`, { opacity: 1, scale: 1.5, duration: 0.5 }, "-=1");

                const titleId = `#city-${index}-title`; const articleId = `#city-${index}-article`; const flowStart = `flow-${index}`;
                let hasArticle = item.parsedNotes && item.parsedNotes.length > 0;
                let titleInStart = tl.duration();

                if (!item.stay) { 
                    tl.to(titleId, { y: 0, x: "0%", yPercent: -50, autoAlpha: 1, duration: 2, ease: "power2.out" }, titleInStart); 
                    tl.addLabel(`cardCenter-${index}`); 
                    tl.to({}, { duration: 1.5 }); 
                } else {
                    tl.addLabel(`cardCenter-${index}`);
                }
                
                tl.addLabel(flowStart);
                
                if (!item.stay) {
                    if (hasArticle) {
                        tl.to("#map-dim-layer", { opacity: 0.85, duration: 1.5 }, flowStart); 
                        tl.to(["#markers-layer", "#route-layer"], { opacity: 0.3, duration: 1.5 }, flowStart);
                    }
                    tl.to(titleId, { y: "-150vh", autoAlpha: 0, duration: 2, ease: "power1.in" }, flowStart); 
                }

                let timeOffset = 2; const SECTION_VH = 80; 
                let lastMoveStart = 0; 
                
                if (item.stay) {
                    tl.fromTo(articleId, { y: "100vh" }, { y: `-50vh`, duration: 4, ease: "none" }, flowStart); timeOffset += 4;
                } else if (hasArticle) { 
                    
                    let currentY = -40; 
                    tl.fromTo(articleId, { y: "50vh", autoAlpha: 0 }, { y: `${currentY}vh`, autoAlpha: 1, duration: 2, ease: "power2.out" }, flowStart);

                    item.parsedNotes.forEach((note, noteIndex) => {
                        let isMulti = note.subNotes.length > 1; 
                        let numImages = note.subNotes.length;
                        let centerTime; 

                        if (numImages > 0) {
                            initDynamicHover(`wrapper-${index}-${noteIndex}`, index, noteIndex, numImages);
                        }

                        if (isMulti) {
                            // üí° Â§öÂúñÂçÄÂ°äÔºöÂÆåÁæéÁΩÆ‰∏≠Ë®àÁÆó
                            let moveDur = 2.5;
                            if (noteIndex > 0) {
                                let nextY = currentY - SECTION_VH; 
                                tl.to(articleId, { y: `${nextY}vh`, duration: moveDur, ease: "power2.inOut" }, `${flowStart}+=${timeOffset}`);
                                currentY = nextY;
                                timeOffset += moveDur; 
                            }
                            
                            let holdTime = 4; 
                            let staggerGap = 1.8; 
                            let appearTime = timeOffset; 

                            // Á¢∫‰øùË∑≥ËΩâÈå®ÈªûÊòØÁ¨¨‰∏ÄÂºµÁÖßÁâáÂÆåÂÖ®Â±ïÈñãÁöÑÊôÇÂàª
                            tl.addLabel(`section-${index}-${noteIndex}`, `${flowStart}+=${appearTime + 1.2}`);

                            note.subNotes.forEach((sn, i) => {
                                let itemLabel = `${flowStart}+=${appearTime + (i * staggerGap)}`;
                                let parallaxDuration = (numImages - i) * holdTime + 0.5; 
                                let parallaxSpeed = 1; 
                                let moveDist = parallaxDuration * parallaxSpeed; 
                                
                                if (sn.photo) {
                                    let frameId = `frame-${index}-${noteIndex}-${i}`; let imgId = `#img-${index}-${noteIndex}-${i}`;
                                    let wrapperId = `wrapper-${index}-${noteIndex}`;
                                    let xOffset = (i - (numImages - 1) / 2) * 20; let yOffset = (i - (numImages - 1) / 2) * 20; 
                                    let endRot = (i % 2 === 0 ? -2 : 3) + (Math.random() * 2 - 1); 
                                    
                                    frameBaseTransforms.set(frameId, { x: xOffset, y: yOffset, rotation: endRot });

                                    tl.fromTo(`#${frameId}`, 
                                        { scale: 1.4, opacity: 0, rotation: endRot*2, x: 0, y: 0, xPercent: -50, yPercent: -50 }, 
                                        { scale: 1, opacity: 1, rotation: endRot, x: xOffset, y: yOffset, xPercent: -50, yPercent: -50, duration: 1.2, ease: "power2.out", 
                                          onStart: () => { const el = document.querySelector(imgId); if(el && el.tagName === 'VIDEO') el.play(); },
                                          onComplete: () => {
                                              let wrapper = document.getElementById(wrapperId);
                                              if (wrapper) {
                                                  wrapper.classList.add("interactive-ready");
                                                  if (wrapper.isHovered && window.innerWidth > 768) setTimeout(() => applyDynamicFanEffect(wrapper, index, noteIndex, numImages), 50);
                                              }
                                          } 
                                        }, itemLabel
                                    );
                                    
                                    tl.fromTo(imgId, { y: 0 }, { y: -moveDist, duration: parallaxDuration, ease: "none" }, `${itemLabel}+=0.5`);
                                }
                                
                                if (i === 0) {
                                    let subId = `#subtitle-${index}-${noteIndex}`;
                                    tl.fromTo(subId, { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 1, ease: "power2.out" }, itemLabel);
                                    tl.to(subId, { y: -moveDist, duration: parallaxDuration, ease: "none" }, `${itemLabel}+=0.5`);
                                }
                                if (sn.text) {
                                    let txtId = `#txt-${index}-${noteIndex}-${i}`;
                                    tl.fromTo(txtId, { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 1, ease: "power2.out" }, itemLabel);
                                    tl.to(txtId, { y: -moveDist, duration: parallaxDuration, ease: "none" }, `${itemLabel}+=0.5`);
                                }
                            });
                            
                            timeOffset += (numImages * staggerGap) + 3; 

                        } else {
                            // üí° 2. Ê•µËá¥‰øÆÂæ©ÔºöÂñÆÂúñÂçÄÂ°äÊªëÂãï‰∏çÈÄ£Ë≤´ÂïèÈ°å„ÄÇÂä†ÂÖ• Hold ÊôÇÈñìËàáÁ∑©ÂÖ•Á∑©Âá∫„ÄÇ
                            let slideDur = 3; 
                            let holdDur = 3; // Âº∑Âà∂Âú®Ëû¢ÂπïÊ≠£‰∏≠ÈñìÂÅúÁïô 3 Áßí
                            
                            if (noteIndex > 0) {
                                let nextY = currentY - SECTION_VH; 
                                tl.to(articleId, { y: `${nextY}vh`, duration: slideDur, ease: "power2.inOut" }, `${flowStart}+=${timeOffset}`);
                                currentY = nextY;
                                lastMoveStart = timeOffset;
                            } else {
                                lastMoveStart = 0; 
                            }

                            centerTime = (noteIndex === 0) ? 2 : lastMoveStart + slideDur; 
                            let appearTime = (noteIndex === 0) ? 0.5 : lastMoveStart + (slideDur * 0.4);
                            
                            // Â∞áË∑≥ËΩâÈªûÁ≤æÊ∫ñË®≠ÁΩÆÂú®ÂÅúÁïôÊôÇÈñìÁöÑ‰∏≠Èñì
                            tl.addLabel(`section-${index}-${noteIndex}`, `${flowStart}+=${centerTime + (holdDur / 2)}`);
                            
                            let itemLabel = `${flowStart}+=${appearTime}`;
                            
                            note.subNotes.forEach((sn, i) => { 
                                if (sn.photo) {
                                    let frameId = `frame-${index}-${noteIndex}-${i}`; let imgId = `#img-${index}-${noteIndex}-${i}`;
                                    let wrapperId = `wrapper-${index}-${noteIndex}`;
                                    let endRot = (Math.random() > 0.5 ? -2 : 3) + (Math.random() * 2 - 1); 

                                    frameBaseTransforms.set(frameId, { x: 0, y: 0, rotation: endRot });

                                    tl.fromTo(`#${frameId}`, 
                                        { scale: 1.4, opacity: 0, rotation: endRot*2, x: 0, y: 0, xPercent: -50, yPercent: -50 }, 
                                        { scale: 1, opacity: 1, rotation: endRot, x: 0, y: 0, xPercent: -50, yPercent: -50, duration: 1.2, ease: "power2.out", 
                                          onStart: () => { const el = document.querySelector(imgId); if(el && el.tagName === 'VIDEO') el.play(); },
                                          onComplete: () => {
                                              let wrapper = document.getElementById(wrapperId);
                                              if (wrapper) {
                                                  wrapper.classList.add("interactive-ready");
                                                  if (wrapper.isHovered && window.innerWidth > 768) setTimeout(() => applyDynamicFanEffect(wrapper, index, noteIndex, 1), 50);
                                              }
                                          } 
                                        }, itemLabel
                                    );
                                    
                                    tl.fromTo(imgId, { y: 0 }, { y: -10, duration: slideDur + holdDur, ease: "none" }, `${itemLabel}+=0.5`);
                                }
                                
                                if (i === 0) {
                                    let subId = `#subtitle-${index}-${noteIndex}`;
                                    tl.fromTo(subId, { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 1, ease: "power2.out" }, itemLabel);
                                }
                                if (sn.text) {
                                    let txtId = `#txt-${index}-${noteIndex}-${i}`;
                                    tl.fromTo(txtId, { y: 20, opacity: 0 }, { y: 0, opacity: 1, duration: 1, ease: "power2.out" }, itemLabel);
                                }
                            });
                            
                            // Âª∂ÈÅ≤‰∏ã‰∏ÄÊÆµÂãïÁï´ÁöÑÈñãÂßãÊôÇÈñìÔºåË£ΩÈÄ†ÂÅúÁïôÊÑü
                            tl.to({}, { duration: holdDur }, `${flowStart}+=${centerTime}`);
                            timeOffset = centerTime + holdDur; 
                        }
                    });

                    let isLastMulti = item.parsedNotes[item.parsedNotes.length - 1].subNotes.length > 1;
                    if (isLastMulti) {
                        tl.to(articleId, { y: `${currentY - SECTION_VH}vh`, autoAlpha: 0, duration: 2, ease: "power1.in" }, `${flowStart}+=${timeOffset}`);
                        timeOffset += 2;
                    } else {
                        tl.to(articleId, { y: `${currentY - SECTION_VH}vh`, duration: 4, ease: "none" }, `${flowStart}+=${timeOffset - 4}`);
                        tl.to(articleId, { autoAlpha: 0, duration: 1.5, ease: "power1.in" }, `${flowStart}+=${timeOffset - 1.5}`);
                    }
                }

                let scrollDur = timeOffset; const flowEnd = `flowEnd-${index}`; tl.addLabel(flowEnd, `${flowStart}+=${scrollDur}`);
                
                if (!item.stay && hasArticle) { 
                    tl.to("#map-dim-layer", { opacity: 0, duration: 0.8 }, flowEnd); 
                    tl.to(["#markers-layer", "#route-layer"], { opacity: 1, duration: 0.8 }, flowEnd); 
                }

                const labelEl = document.getElementById(`label-${index}`);
                if (labelEl && labelEl.style.display !== 'none') {
                    if (item.stay) { tl.to(`#label-${index}`, { autoAlpha: 1, y: "0%", duration: 0.5, ease: "back.out(1.7)" }, flowStart); tl.to(`#label-${index}`, { autoAlpha: 0, duration: 0.5 }, flowEnd); } 
                    else { tl.to(`#label-${index}`, { autoAlpha: 1, y: "0%", duration: 0.5, ease: "back.out(1.7)" }, `${flowEnd}-=0.5`); }
                }
                if (item.type === 'end') {
                    const startIndex = STORY_DATA.findIndex(d => d.type === 'start' && d.city === item.city);
                    if (startIndex !== -1) tl.to(`#end-date-${startIndex}`, { autoAlpha: 1, height: "auto", marginTop: "0.5px", duration: 0.5 }, `${flowEnd}-=0.5`);
                }
                
                if (!item.stay && item.type === 'waypoint') {
                    let firstVisitIndex = STORY_DATA.findIndex(d => d.type === 'waypoint' && d.city === item.city);
                    if (firstVisitIndex !== -1 && firstVisitIndex < index) {
                        let revisitCommaId = `#revisit-comma-${item.city}`;
                        let revisitSpanId = `#revisit-date-${item.city}`;
                        tl.to([revisitCommaId, revisitSpanId], { autoAlpha: 1, width: "auto", height: "auto", duration: 0.5 }, flowStart);
                    }
                }
            });

            // üí° 4. Ê•µËá¥‰øÆÂæ©ÔºöÊîæÂØ¨Âú∞ÂúñÊúÄÁµÇÁ∏ÆÊîæÁöÑÈÇäË∑ùÔºåÁ¢∫‰øùÊâÄÊúâÂüéÂ∏ÇÊ®ôÁ±§ÈÉΩ‰∏çË¢´ÂàáÊéâ
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;

            STORY_DATA.forEach(item => {
                if (item.coords.x < minX) minX = item.coords.x; if (item.coords.x > maxX) maxX = item.coords.x;
                if (item.coords.y < minY) minY = item.coords.y; if (item.coords.y > maxY) maxY = item.coords.y;
            });
            const padding = 100; 
            const bbWidth = (maxX - minX) + padding * 2; const bbHeight = (maxY - minY) + padding * 2;
            const centerX = (minX + maxX) / 2; const centerY = (minY + maxY) / 2;
            let finalScale = Math.max(1, Math.min(Math.min(1000 / bbWidth, 1000 / bbHeight), 4)); 
            const finalPos = getFixedPosition(centerX, centerY, finalScale);

            tl.to("#map-content-wrapper", { scale: finalScale, x: finalPos.x, y: finalPos.y, duration: 2.5, ease: "power2.inOut" }, "zoomOut"); 
            tl.to(".city-label", { scale: 4.5 / finalScale, duration: 2.5, ease: "power2.inOut" }, "zoomOut");
            tl.to("#end-title-layer", { y: "0%", autoAlpha: 1, duration: 1.5, ease: "power2.out" }, "zoomOut+=1"); 
        }

        window.onload = initStory;
    </script>
</body>
</html>